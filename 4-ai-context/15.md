# Microphone Streaming Implementation

## Overview

This document describes the implementation of real-time microphone streaming from the T5AI DevKit to the web application via TCP.

## Architecture

```
┌─────────────────┐     TCP (port 5000)     ┌─────────────────┐     WebSocket     ┌─────────────────┐
│   T5AI DevKit   │ ─────────────────────── │   VPS Server    │ ─────────────────│   Web Browser   │
│                 │                          │   (Node.js)     │                   │                 │
│  ┌───────────┐  │    audio: prefix +      │                 │  binary audio +  │  ┌───────────┐  │
│  │ Onboard   │──│──► binary PCM data      │  ┌───────────┐  │  JSON header     │  │Web Audio  │  │
│  │ Microphone│  │                          │  │  Forward  │──│──────────────────│──│ API       │  │
│  └───────────┘  │                          │  │  Audio    │  │                   │  │ Playback  │  │
│                 │                          │  └───────────┘  │                   │  └───────────┘  │
└─────────────────┘                          └─────────────────┘                   └─────────────────┘
```

## Audio Format

- **Sample Rate**: 8000 Hz
- **Bit Depth**: 16-bit signed PCM
- **Channels**: Mono (1 channel)
- **Frame Size**: 320 bytes (20ms of audio)
- **Data Rate**: ~16 KB/s

## Components

### 1. DevKit Firmware (`mic_streaming.c`)

- **mic_streaming_init()**: Initializes the ring buffer and audio device
- **mic_streaming_start()**: Starts capturing audio and streaming via TCP
- **mic_streaming_stop()**: Stops audio capture and streaming
- **Audio Callback**: Called by the audio driver for each frame, stores in ring buffer
- **Streaming Task**: Reads from ring buffer and sends via TCP with `audio:` prefix

### 2. TCP Commands

| Command | Response | Description |
|---------|----------|-------------|
| `mic on` | `ok:mic_on` | Start microphone streaming |
| `mic off` | `ok:mic_off` | Stop microphone streaming |
| `mic status` | JSON with bytes/frames sent | Get streaming stats |

### 3. Server (`server.js`)

- Detects `audio:` prefix in incoming TCP messages
- Extracts binary PCM data after the prefix
- Broadcasts audio data to authenticated WebSocket clients
- Sends JSON header followed by binary audio data

### 4. Web Application (`index.html`)

- MIC ON / MIC OFF buttons in Quick Commands
- Web Audio API for real-time playback at 8000Hz
- Audio queue with seamless playback
- Visual feedback showing streaming status and bytes received

## Usage

1. **Start Streaming**:
   - Click "MIC ON" button in the web app
   - DevKit starts capturing and streaming audio
   - Audio plays through browser speakers

2. **Stop Streaming**:
   - Click "MIC OFF" button
   - DevKit stops audio capture
   - Browser stops audio playback

## Protocol Details

### TCP Message Format
```
[4 bytes: length (LE)] [6 bytes: "audio:"] [N bytes: PCM data]
```

### WebSocket Broadcast
```
1. JSON header: {"type":"audio_data","sampleRate":8000,"channels":1,"bitsPerSample":16,"length":N}\n
2. Binary audio data: N bytes of PCM samples
```

## Files Modified/Created

### New Files
- `apps/tuya_cloud/object_detection/src/mic_streaming.h`
- `apps/tuya_cloud/object_detection/src/mic_streaming.c`

### Modified Files
- `apps/tuya_cloud/object_detection/src/tuya_main.c` - Added mic commands
- `webapp/server.js` - Added audio forwarding
- `webapp/public/index.html` - Added mic controls and audio playback

## Build & Deploy

### Firmware
```bash
cd /home/uratmangun/CascadeProjects/TuyaOpen/apps/tuya_cloud/object_detection
python3 ../../../tos.py build
python3 ../../../tos.py flash -p /dev/ttyACM0
```

### Web Application
```bash
cd /home/uratmangun/CascadeProjects/TuyaOpen/webapp
podman build -t tuya-webapp:latest .
podman save tuya-webapp:latest | gzip > /tmp/tuya-webapp.tar.gz
scp /tmp/tuya-webapp.tar.gz ubuntu@YOUR_TAILSCALE_IP:/tmp/
ssh ubuntu@YOUR_TAILSCALE_IP "podman stop tuya-webapp; podman rm tuya-webapp; podman load -i /tmp/tuya-webapp.tar.gz && podman run -d --name tuya-webapp --network tunnel-net -e AUTH_USERNAME=admin -e AUTH_PASSWORD=YOUR_AUTH_PASSWORD -e AUTH_TOKEN=YOUR_AUTH_TOKEN -e HTTP_PORT=3000 -e TCP_PORT=5000 -p 5000:5000 localhost/tuya-webapp:latest"
```

## Notes

- Browser requires user interaction before playing audio (autoplay policy)
- Audio context is created at 8000Hz to match DevKit sample rate
- Ring buffer prevents audio drops during network delays
- Keep-alive pings ensure stable TCP connection
