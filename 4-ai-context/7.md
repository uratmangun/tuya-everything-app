# Session 7: Android App for RTSP â†’ Tuya Cloud AI â†’ DevKit

## Goal
Create an Android app that:
1. Captures RTSP video feed from local camera
2. Sends frames to Tuya Cloud AI for person detection
3. Triggers T5AI DevKit to play audio alert when person detected

## Architecture
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   RTSP Camera   â”‚ â”€â”€â”€â”€â”€â”€â–º â”‚  Android Phone  â”‚ â”€â”€â”€â”€â”€â”€â–º â”‚  Tuya Cloud AI  â”‚
â”‚   (Local)       â”‚  RTSP   â”‚  (This App)     â”‚  HTTPS  â”‚  Person Detect  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚                           â”‚
                                     â”‚ If person detected        â”‚
                                     â–¼                           â”‚
                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
                            â”‚  T5AI DevKit    â”‚ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚  (Play Alert)   â”‚   Tuya Cloud Command
                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Why Android App?
- No 24/7 PC needed
- Phone is always on and connected to same network as devkit
- More practical than running Python script on server

## RTSP Camera URL
```
rtsp://admin:Admin1234@192.168.18.34:554/live/ch00_0
```

## What Was Created

### Android Project Structure
```
apps/tuya_cloud/object_detection/android/
â”œâ”€â”€ build.gradle.kts           # Root build config
â”œâ”€â”€ settings.gradle.kts        # Project settings
â”œâ”€â”€ gradle.properties          # Gradle properties
â”œâ”€â”€ gradlew                    # Gradle wrapper script
â”œâ”€â”€ build.sh                   # Build helper script
â”œâ”€â”€ README.md                  # Setup instructions
â”œâ”€â”€ gradle/wrapper/
â”‚   â”œâ”€â”€ gradle-wrapper.jar
â”‚   â””â”€â”€ gradle-wrapper.properties
â””â”€â”€ app/
    â”œâ”€â”€ build.gradle.kts       # App build config with dependencies
    â””â”€â”€ src/main/
        â”œâ”€â”€ AndroidManifest.xml
        â”œâ”€â”€ java/com/tuya/persondetector/
        â”‚   â”œâ”€â”€ Config.kt      # Configuration (credentials, RTSP URL)
        â”‚   â”œâ”€â”€ MainActivity.kt # Main UI with RTSP viewer
        â”‚   â””â”€â”€ TuyaApi.kt     # Tuya Cloud API client
        â””â”€â”€ res/
            â”œâ”€â”€ layout/activity_main.xml
            â””â”€â”€ values/
                â”œâ”€â”€ strings.xml
                â”œâ”€â”€ colors.xml
                â””â”€â”€ themes.xml
```

### Key Files Created

#### 1. Config.kt - App Configuration
```kotlin
object Config {
    var accessId = "your_access_id"
    var accessSecret = "your_access_secret"
    var apiEndpoint = "https://openapi.tuyaus.com"
    var deviceId = "your_device_id"
    var rtspUrl = "rtsp://admin:Admin1234@192.168.18.34:554/live/ch00_0"
    const val DETECTION_INTERVAL_MS = 3000L
    const val DP_SWITCH_ID = "1"
}
```

#### 2. TuyaApi.kt - Tuya Cloud API Client
- Token authentication with HMAC-SHA256 signing
- Person detection via `/v1.0/ai/image/detect`
- Device control via `/v1.0/devices/{id}/commands`

#### 3. MainActivity.kt - Main App
- RTSP video display using TextureView + MediaPlayer
- Frame capture every 3 seconds
- Send to Tuya Cloud AI for analysis
- Trigger devkit when person detected
- Log display for debugging

## Credentials Needed

### Device Credentials (Already Have)
- Product ID
- UUID + AuthKey

### Cloud API Credentials (Need to Get)
1. Go to [iot.tuya.com](https://iot.tuya.com)
2. Navigate to **Cloud** â†’ **Development**
3. Create Cloud Project
4. Enable **AI Image Recognition** service
5. Copy:
   - **Access ID** (Client ID)
   - **Access Secret** (Client Secret)

## Environment Setup Done

### Installed
- Java 17 (required for Android SDK)
- Android SDK command line tools
- Android SDK Platform 34
- Android SDK Build Tools 34.0.0
- Platform Tools

### Environment Variables
```bash
export JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64
export ANDROID_HOME=~/Android/Sdk
```

## Build Commands

```bash
cd /home/uratmangun/CascadeProjects/TuyaOpen/apps/tuya_cloud/object_detection/android

# Set environment
export JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64
export ANDROID_HOME=~/Android/Sdk

# Build APK
./gradlew assembleDebug

# Install to phone (connected via ADB)
adb install -r app/build/outputs/apk/debug/app-debug.apk
```

## Phone Connected
```
$ adb devices
List of devices attached
R5CW31FEGNJ     device
```

## Next Steps

1. **Get Tuya Cloud API credentials** from iot.tuya.com
2. **Update Config.kt** with credentials
3. **Build APK**: `./gradlew assembleDebug`
4. **Install on phone**: `adb install -r app/build/outputs/apk/debug/app-debug.apk`
5. **Test the flow**:
   - Launch app
   - Enter credentials
   - Tap Start
   - Walk in front of camera
   - DevKit should play alert!

## Previous Sessions Summary

| Session | What Was Done |
|---------|---------------|
| 4 | Fixed audio playback - identified MP3 decoding working but no sound |
| 5 | Found root cause: Speaker GPIO39 not enabled. Fixed by explicitly setting GPIO HIGH |
| 6 | Fixed app hanging (duplicate commands), fixed volume control with GPIO mute |
| 7 | Created Android app for RTSP â†’ Tuya Cloud AI â†’ DevKit pipeline |

## Git Commits Made
- `feat(object_detection): âœ¨ add audio alert app with speaker GPIO fix`
- `fix(audio): ğŸ”§ add volume control with speaker gpio mute`
