# Audio Fix Session - Part 5

## Problem
Audio was still not playing despite previous fixes. The device shows:
- Audio player initializes successfully
- Audio device opens successfully
- Volume is set successfully
- MP3 data is decoded and sent to speaker (`[ONBOARD_SPK] data_size: 40320(Bytes)`)
- But **no sound comes out of the speaker**

## Root Cause Found

### Speaker Amplifier Enable GPIO Not Enabled

The T5AI-CORE devkit has a **speaker amplifier enable pin** on **GPIO39**. This GPIO must be set **HIGH** to enable the speaker amplifier.

Looking at the code flow:

1. **Board Configuration** (`tuya_t5ai_core.c`):
   ```c
   cfg.spk_pin = BOARD_SPEAKER_EN_PIN;  // GPIO39
   cfg.spk_pin_polarity = TUYA_GPIO_LEVEL_LOW;  // LOW = muted, HIGH = enabled
   ```

2. **Audio Driver Init** (`tkl_audio.c`):
   - GPIO39 is initialized with `TUYA_GPIO_LEVEL_HIGH` (speaker off initially)
   - `tkl_ai_set_vol()` is the ONLY function that toggles this GPIO

3. **The Bug**:
   - Our code calls `ai_audio_set_volume()` which routes to `tkl_ao_set_vol()`
   - `tkl_ao_set_vol()` only sets the **DAC gain** - it does NOT control the speaker enable GPIO
   - Only `tkl_ai_set_vol()` controls the speaker enable GPIO
   - Result: Speaker amplifier is never enabled!

## Fix Applied

In `/apps/tuya_cloud/object_detection/src/tuya_main.c`, after opening the audio device, we now **explicitly enable the speaker GPIO**:

```c
/* Enable speaker amplifier GPIO (GPIO39 on T5AI-CORE) */
/* Speaker is active when GPIO is HIGH (polarity=LOW means LOW=mute) */
PR_INFO("Enabling speaker amplifier (GPIO39)...");
TUYA_GPIO_BASE_CFG_T spk_gpio_cfg = {
    .direct = TUYA_GPIO_OUTPUT,
    .mode = TUYA_GPIO_PUSH_PULL,
    .level = TUYA_GPIO_LEVEL_HIGH  /* HIGH = speaker enabled */
};
rt = tkl_gpio_init(TUYA_GPIO_NUM_39, &spk_gpio_cfg);
if (rt != OPRT_OK) {
    PR_ERR("Failed to init speaker GPIO: %d", rt);
} else {
    rt = tkl_gpio_write(TUYA_GPIO_NUM_39, TUYA_GPIO_LEVEL_HIGH);
    if (rt != OPRT_OK) {
        PR_ERR("Failed to enable speaker GPIO: %d", rt);
    } else {
        PR_INFO("Speaker amplifier enabled (GPIO39=HIGH)");
    }
}
```

## Verification Steps

1. Build the firmware:
   ```bash
   cd /home/uratmangun/CascadeProjects/TuyaOpen/apps/tuya_cloud/object_detection
   python ../../tos.py build
   ```

2. Flash to device:
   ```bash
   python ../../tos.py flash
   ```

3. Monitor the logs to see:
   ```
   [ty I] Enabling speaker amplifier (GPIO39)...
   [ty I] Speaker amplifier enabled (GPIO39=HIGH)
   ```

4. Toggle the switch in the Tuya Smart Life app - audio should now play!

## Technical Notes

### Speaker Enable GPIO Logic on T5AI boards:
| `spk_pin_polarity` | GPIO LOW | GPIO HIGH |
|-------------------|----------|-----------|
| 0 (LEVEL_LOW)     | Muted    | Enabled   |
| 1 (LEVEL_HIGH)    | Enabled  | Muted     |

### Audio Data Flow:
1. MP3 data → `ai_audio_player_data_write()` → ring buffer
2. Player task reads from ring buffer → `mp3dec_decode_frame()` → PCM data
3. PCM data → `tdl_audio_play()` → `tkl_ao_put_frame()` → DAC → Speaker

### Key Functions:
- `tkl_ai_set_vol()` - Sets mic volume AND controls speaker enable GPIO
- `tkl_ao_set_vol()` - Sets DAC gain only (no GPIO control)
- `tdl_audio_volume_set()` → routes to `tkl_ao_set_vol()` (no GPIO!)
