# Voice Message API - CORS and Bearer Token Authentication

## Summary

Added CORS support and Bearer token authentication to the `/api/voice-message` endpoint, allowing external applications to send voice messages to the connected DevKit from anywhere using the `AUTH_TOKEN`.

## Architecture

```
┌─────────────────┐                           ┌─────────────────┐      TCP Protocol    ┌─────────────────┐
│  External App   │  POST /api/voice-message  │   Go Server     │ ──────────────────► │   T5AI DevKit   │
│  (anywhere)     │ ────────────────────────► │   (VPS)         │   voicestart/vd/end │                 │
│                 │  Authorization: Bearer    │                 │                     │                 │
│                 │  + audio/webm body        │  FFmpeg → MP3   │                     │  Play audio     │
└─────────────────┘                           └─────────────────┘                     └─────────────────┘
```

## Changes Made

### webapp/main.go

#### 1. Added CORS Middleware

```go
// corsMiddleware adds CORS headers for cross-origin requests
func corsMiddleware(next http.Handler) http.Handler {
	return http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
		// Allow requests from any origin
		w.Header().Set("Access-Control-Allow-Origin", "*")
		w.Header().Set("Access-Control-Allow-Methods", "GET, POST, PUT, DELETE, OPTIONS")
		w.Header().Set("Access-Control-Allow-Headers", "Content-Type, Authorization")
		w.Header().Set("Access-Control-Max-Age", "86400") // 24 hours

		// Handle preflight requests
		if r.Method == "OPTIONS" {
			w.WriteHeader(http.StatusNoContent)
			return
		}

		next.ServeHTTP(w, r)
	})
}
```

#### 2. Added Bearer Token Authentication

```go
// checkBearerToken validates Authorization: Bearer <token> header
func checkBearerToken(r *http.Request) bool {
	authHeader := r.Header.Get("Authorization")
	if authHeader == "" {
		return false
	}
	// Expect "Bearer <token>"
	if !strings.HasPrefix(authHeader, "Bearer ") {
		return false
	}
	token := strings.TrimPrefix(authHeader, "Bearer ")
	return token == authToken
}

// Token-authenticated API endpoints (accessible from anywhere with valid token)
var tokenAuthPaths = []string{
	"/api/voice-message",
}

func isTokenAuthPath(path string) bool {
	for _, p := range tokenAuthPaths {
		if path == p {
			return true
		}
	}
	return false
}
```

#### 3. Updated Auth Middleware

The `authMiddleware` now checks for Bearer token on token-authenticated paths before falling back to session cookie:

```go
// Token-authenticated endpoints: allow Bearer token OR session cookie
if isTokenAuthPath(path) {
	// First try Bearer token
	if checkBearerToken(r) {
		next.ServeHTTP(w, r)
		return
	}
	// Fall through to session check
}
```

#### 4. Applied CORS Middleware

```go
// Apply CORS middleware first, then auth middleware
handler := corsMiddleware(authMiddleware(mux))
```

## API Usage

### External API Call (from anywhere)

```bash
curl -X POST https://your-server:3000/api/voice-message \
  -H "Authorization: Bearer YOUR_AUTH_TOKEN" \
  -H "Content-Type: audio/webm" \
  --data-binary @recording.webm
```

### Response

Success:
```json
{
  "success": true,
  "mp3Bytes": 12345
}
```

Error (no DevKit connected):
```json
{
  "error": "DevKit not connected",
  "mp3Bytes": 12345
}
```

## Authentication Methods

The `/api/voice-message` endpoint now supports two authentication methods:

| Method | Header | Use Case |
|--------|--------|----------|
| Bearer Token | `Authorization: Bearer <AUTH_TOKEN>` | External API access |
| Session Cookie | `Cookie: session=<signed_session>` | Web UI (existing) |

## Environment Variables

| Variable | Default | Description |
|----------|---------|-------------|
| `AUTH_TOKEN` | `YOUR_AUTH_TOKEN` | Token for Bearer authentication |

## Voice Message Flow

1. Client sends POST to `/api/voice-message` with WebM/Opus audio
2. Server validates Bearer token OR session cookie
3. FFmpeg converts WebM → MP3 (16kHz mono, 64kbps, 3x volume boost)
4. Server sends MP3 to DevKit via TCP using chunked protocol:
   - `voicestart:<total_length>`
   - Multiple `vd:<chunk_data>` (1KB chunks)
   - `voiceend`
5. DevKit plays the audio

## Deployment

```fish
cd /home/uratmangun/CascadeProjects/TuyaOpen/webapp
rsync -avz --exclude='.git' . ubuntu@YOUR_TAILSCALE_IP:~/tuya-webapp/

ssh ubuntu@YOUR_TAILSCALE_IP "
  podman stop tuya-webapp-go 2>/dev/null
  podman rm tuya-webapp-go 2>/dev/null
  cd ~/tuya-webapp
  podman build -t tuya-webapp-go:latest .
  podman run -d --name tuya-webapp-go --network host \
    -e AUTH_USERNAME=admin \
    -e AUTH_PASSWORD=YOUR_AUTH_PASSWORD \
    -e AUTH_TOKEN=YOUR_AUTH_TOKEN \
    -e HTTP_PORT=3000 \
    -e TCP_PORT=5000 \
    -e UDP_PORT=5001 \
    tuya-webapp-go:latest
"
```

## Related Files

| File | Purpose |
|------|---------|
| `webapp/main.go` | Go server with CORS and Bearer token auth |
| `webapp/.env.production` | Environment variables including AUTH_TOKEN |
