# Session 10: Fixing BLE WiFi List Response Parsing & TCP Control

## Problem
1. When clicking "Scan WiFi" on the Web Bluetooth page, the DevKit sends the WiFi list back, but the web page was showing raw bytes in the BLE log instead of displaying the WiFi networks.
2. **CRITICAL**: Clicking "Disconnect WiFi" caused a device crash (MemFault - NULL pointer dereference) because the TCP client was trying to use sockets while WiFi was being disconnected.
3. RTSP tunnel configuration was being logged on every boot even though it wasn't being used.

## Root Causes Identified

### 1. Incorrect Mode 0 Decryption in Web Crypto
The `tuya-ble-crypto.js` file's `decryptPacket` function was only skipping 1 byte (the mode byte) for mode 0 (unencrypted), but the DevKit always sends packets with the format:
```
mode(1 byte) + IV(16 bytes) + data
```

So for mode 0, it was returning `IV + data` instead of just `data`.

### 2. Plain Response Parsing Not Detecting Header
The `handlePlainResponse` function was not properly detecting and skipping the 4-byte header (`flags(2) + channel(2)`) that the DevKit prepends to JSON responses.

### 3. TCP Client Crash on WiFi Disconnect
When WiFi was disconnected, the TCP client was still running and trying to use network sockets, causing a NULL pointer dereference crash.

## Solutions Implemented

### Fix 1: Correct Mode 0 Decryption (tuya-ble-crypto.js)
Changed `decryptPacket` to skip the full 17-byte header for mode 0:

```javascript
if (mode === 0) {
    // Mode 0: No encryption, but packet still has mode(1) + iv(16) + data structure
    // Skip the full 17-byte header
    return encryptedPacket.slice(17);
}
```

### Fix 2: TCP Control Commands (ble_config.c)
Added new BLE commands for TCP management:
- `tcp_connect` - Start TCP client
- `tcp_disconnect` - Stop TCP client
- `get_status` - Now returns `wifi_connected` and `tcp_connected` status

### Fix 3: Safe WiFi Disconnect (ble_config.c)
Updated `wifi_disconnect` handler to first stop TCP before disconnecting WiFi:

```c
/* First stop TCP client to prevent crashes when WiFi goes down */
extern void tcp_client_stop(void);
tcp_client_stop();
tal_system_sleep(100);  /* Let TCP close cleanly */
/* Then disconnect WiFi */
netmgr_conn_set(1, 6, NULL);
```

### Fix 4: Web UI TCP Control (index.html)
- Added TCP status display in TCP Server Settings tab
- Added "Connect TCP" and "Disconnect TCP" buttons
- Updated "Disconnect WiFi" to first disconnect TCP (belt and suspenders approach)
- Added user confirmation before disconnecting WiFi

### Fix 5: Remove RTSP Logging (tuya_main.c)
Removed the RTSP tunnel configuration banner that was printing on every boot.

## Files Modified

### DevKit Firmware
- `apps/tuya_cloud/object_detection/src/ble_config.c`:
  - Added `tcp_client.h` include
  - Enhanced `get_status` to return WiFi and TCP connection status
  - Added `tcp_connect` command handler
  - Added `tcp_disconnect` command handler
  - **Fixed `wifi_disconnect` to stop TCP first!**

- `apps/tuya_cloud/object_detection/src/tuya_main.c`:
  - Removed RTSP tunnel configuration logging

### Web Bluetooth Page
- `ble-config-web/index.html`:
  - Added TCP status display with icons
  - Added "Connect TCP" and "Disconnect TCP" buttons
  - Updated `disconnectWifi()` to disconnect TCP first
  - Added `connectTcp()`, `disconnectTcp()`, `refreshStatus()` functions
  - Improved `updateStatusDisplay()` to update TCP status indicator
  
- `ble-config-web/tuya-ble-crypto.js`:
  - Fixed `decryptPacket` to properly handle mode 0

## Testing

After rebuilding and flashing firmware:

1. **Test TCP Control:**
   - Connect via BLE
   - Go to TCP Server Settings tab
   - See TCP status indicator
   - Click "Disconnect TCP" then "Connect TCP"
   - Status should update accordingly

2. **Test Safe WiFi Disconnect:**
   - Connect via BLE
   - Confirm device is on WiFi (status shows connected)
   - Click "Disconnect WiFi"
   - Confirm dialog appears
   - Device should NOT crash
   - WiFi should disconnect cleanly

3. **Test WiFi Scan:**
   - Click "Scan WiFi"
   - Networks should appear in list
   - BLE Log should show parsed JSON
