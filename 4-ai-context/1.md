# Object Detection Audio Alert - T5AI Project

## Project Overview
A TuyaOpen application for the T5AI devkit that plays audio alerts when a switch DP is toggled via the Tuya Smart Life app.

**Status: ✅ WORKING**

## Project Location
```
/home/uratmangun/CascadeProjects/TuyaOpen/apps/tuya_cloud/object_detection/
```

## Hardware
- **Device**: T5AI Development Kit
- **Serial Ports**: 
  - `/dev/ttyACM0` - Flashing
  - `/dev/ttyACM2` - Monitor/CLI (baud rate: **460800**)

## Tuya Credentials
Stored in `.env` file (gitignored):
```
/home/uratmangun/CascadeProjects/TuyaOpen/apps/tuya_cloud/object_detection/.env
```

Contents:
```bash
export TUYA_PRODUCT_ID="YOUR_PRODUCT_ID"
export TUYA_OPENSDK_UUID="YOUR_UUID"
export TUYA_OPENSDK_AUTHKEY="YOUR_AUTHKEY"
```

## Key Files Modified

### 1. CMakeLists.txt
Added .env file parsing to automatically load credentials at build time:

```cmake
##
# @file CMakeLists.txt
# @brief 
#/

# APP_PATH
set(APP_PATH ${CMAKE_CURRENT_LIST_DIR})

# Read .env file for Tuya credentials
if(EXISTS "${APP_PATH}/.env")
    file(STRINGS "${APP_PATH}/.env" ENV_LINES)
    foreach(LINE ${ENV_LINES})
        if(LINE MATCHES "^export ([A-Z_]+)=\"(.*)\"$")
            set(${CMAKE_MATCH_1} "${CMAKE_MATCH_2}")
        endif()
    endforeach()
endif()

# APP_NAME
get_filename_component(APP_NAME ${APP_PATH} NAME)

# APP_SRCS
aux_source_directory(${APP_PATH}/src APP_SRCS)

# APP_INC
set(APP_INC
    ${APP_PATH}/src
)

########################################
# Target Configure
########################################
add_library(${EXAMPLE_LIB})

target_sources(${EXAMPLE_LIB}
    PRIVATE
        ${APP_SRCS}
    )

target_include_directories(${EXAMPLE_LIB}
    PRIVATE
        ${APP_INC}
    )

# Pass Tuya credentials from .env as compile definitions
if(TUYA_PRODUCT_ID)
    target_compile_definitions(${EXAMPLE_LIB} PRIVATE TUYA_PRODUCT_ID="${TUYA_PRODUCT_ID}")
endif()
if(TUYA_OPENSDK_UUID)
    target_compile_definitions(${EXAMPLE_LIB} PRIVATE TUYA_OPENSDK_UUID="${TUYA_OPENSDK_UUID}")
endif()
if(TUYA_OPENSDK_AUTHKEY)
    target_compile_definitions(${EXAMPLE_LIB} PRIVATE TUYA_OPENSDK_AUTHKEY="${TUYA_OPENSDK_AUTHKEY}")
endif()

########################################
# Add subdirectory
########################################
add_subdirectory(${APP_PATH}/../../tuya.ai/ai_components/ai_audio ai_audio)
```

### 2. tuya_config.h
Credentials with fallback to placeholders:

```c
#ifndef TUYA_PRODUCT_ID
#define TUYA_PRODUCT_ID      "REPLACE_WITH_YOUR_PRODUCT_ID"
#endif

#ifndef TUYA_OPENSDK_UUID
#define TUYA_OPENSDK_UUID    "REPLACE_WITH_YOUR_UUID"
#endif

#ifndef TUYA_OPENSDK_AUTHKEY
#define TUYA_OPENSDK_AUTHKEY "REPLACE_WITH_YOUR_AUTHKEY"
#endif
```

### 3. tuya_main.c - Key Changes

#### Audio Alert Functions
```c
static void play_detection_alert(void)
{
    if (!g_audio_initialized) {
        PR_WARN("Audio not initialized, cannot play alert");
        return;
    }
    
    PR_INFO("Playing detection alert audio...");
    
    OPERATE_RET rt = ai_audio_player_start("detection_alert");
    if (rt != OPRT_OK) {
        PR_ERR("Failed to start audio player: %d", rt);
        return;
    }
    
    rt = ai_audio_player_data_write("detection_alert", 
                                     (uint8_t *)alert_audio_data, 
                                     sizeof(alert_audio_data), 
                                     1);
    if (rt != OPRT_OK) {
        PR_ERR("Failed to write audio data: %d", rt);
    }
}

static void stop_detection_alert(void)
{
    if (!g_audio_initialized) {
        return;
    }
    
    if (ai_audio_player_is_playing()) {
        ai_audio_player_stop();
    }
}
```

#### DP Handler (Switch Toggle)
```c
case PROP_BOOL: {
    PR_DEBUG("bool value:%d", dp->value.dp_bool);
    
    if (dp->id == SWITCH_DP_ID) {
        g_detection_active = dp->value.dp_bool;
        
        /* Report the new state back to the cloud/app immediately */
        tuya_iot_dp_obj_report(client, dpobj->devid, dp, 1, 0);

        if (g_detection_active) {
            PR_INFO("Object Detection: ACTIVATED - Playing alert");
            play_detection_alert();
        } else {
            PR_INFO("Object Detection: DEACTIVATED - Stopping audio");
            stop_detection_alert();
        }
    }
    break;
}
```

#### MQTT Connected Handler (Fixed Crash)
```c
/* MQTT with tuya cloud is connected, device online */
case TUYA_EVENT_MQTT_CONNECTED:
    PR_INFO("Device MQTT Connected!");
    /* TODO: Report initial state after connection stabilizes */
    break;
```

**Note**: Removed DP report from MQTT connected handler - it was causing a null pointer crash.

### 4. alert_audio_data.c / alert_audio_data.h
Pre-built MP3 audio data embedded as a C array.

## Build & Flash Commands

### Configure for T5AI
```bash
cd /home/uratmangun/CascadeProjects/TuyaOpen/apps/tuya_cloud/object_detection
source /home/uratmangun/CascadeProjects/TuyaOpen/.venv/bin/activate
echo "9" | python /home/uratmangun/CascadeProjects/TuyaOpen/tos.py config choice
```

### Build
```bash
cd /home/uratmangun/CascadeProjects/TuyaOpen/apps/tuya_cloud/object_detection
source /home/uratmangun/CascadeProjects/TuyaOpen/.venv/bin/activate
python /home/uratmangun/CascadeProjects/TuyaOpen/tos.py build
```

### Flash
```bash
cd /home/uratmangun/CascadeProjects/TuyaOpen
source .venv/bin/activate
echo "1" | python tools/tyutool/tyutool_cli.py write -d T5AI -f /home/uratmangun/CascadeProjects/TuyaOpen/apps/tuya_cloud/object_detection/.build/bin/object_detection_QIO_1.0.0.bin
```

### Monitor (Python)
```python
import serial
import time
import re

ser = serial.Serial('/dev/ttyACM2', 460800, timeout=1)
while True:
    data = ser.read(4096)
    if data:
        text = data.decode('utf-8', errors='ignore')
        text = re.sub(r'\x1b\[[0-9;]*m', '', text)  # Remove ANSI codes
        print(text, end='', flush=True)
```

## CLI Commands Available
The device has these CLI commands (via serial at 460800 baud):
- `help` - List all commands
- `reset` - Reset IoT to unactivated state
- `switch on/off` - Test switch
- `mem` - Show free heap memory
- `netmgr` - Network manager commands

## Issues Resolved

### 1. Device Not Connecting to WiFi
**Cause**: Corrupted WiFi credentials or wrong firmware
**Solution**: Reflashed the `object_detection` app with correct credentials

### 2. Wrong Baud Rate for Monitor
**Cause**: Using 115200 instead of 460800
**Solution**: Use 460800 baud rate for ttyACM2

### 3. Crash After MQTT Connected
**Cause**: Calling `tuya_iot_dp_obj_report()` in `TUYA_EVENT_MQTT_CONNECTED` handler caused null pointer dereference
**Solution**: Removed the DP report from MQTT connected handler

### 4. Credentials Not Loading
**Cause**: Hardcoded placeholders in tuya_config.h
**Solution**: Added CMake code to read `.env` file and pass credentials as compile definitions

## Working Features
- ✅ WiFi connection
- ✅ MQTT connection to Tuya cloud
- ✅ BLE pairing
- ✅ Switch DP toggle from Smart Life app
- ✅ Audio playback on switch ON
- ✅ Audio stop on switch OFF
- ✅ State reporting back to app
- ✅ LAN control (local network)
- ✅ Credentials loaded from .env file

## Sample Log Output (Working)
```
[12-17 18:18:07 ty D][mqtt_service.c:236] Data JSON:{"data":{"dps":{"1":true}},"protocol":5,"t":1765970285}
[12-17 18:18:07 ty D][tuya_main.c:214] bool value:1
[12-17 18:18:07 ty I][tuya_main.c:224] Object Detection: ACTIVATED - Playing alert
[12-17 18:18:07 ty I][tuya_main.c:81] Playing detection alert audio...
[12-17 18:18:07 ty D][ai_audio_player.c:209] ai audio player stat changed: 0->1
[12-17 18:18:07 ty N][ai_audio_player.c:417] ai audio player start
[12-17 18:18:07 ty D][ai_audio_player.c:209] ai audio player stat changed: 1->2
[12-17 18:18:07 ty D][ai_audio_player.c:254] app player end
[12-17 18:18:07 ty D][ai_audio_player.c:209] ai audio player stat changed: 2->3
[12-17 18:18:07 ty D][ai_audio_player.c:209] ai audio player stat changed: 3->0
```

## Device Info
```
Project name:        object_detection
App version:         1.0.0
TuyaOpen version:    v1.5.1
Platform chip:       T5AI
Platform board:      TUYA_T5AI_BOARD
Device ID:           eb4c2bd1bf0bbaa232ehyh
```

## Next Steps (Optional)
1. Add actual object detection logic (camera/sensor integration)
2. Add different audio alerts for different detection types
3. Add volume control via DP
4. Add detection sensitivity settings
