# Session 9: Fixing BLE Bidirectional Communication

## Problem
The Web Bluetooth page could send commands to the DevKit, but the DevKit wasn't sending data back to the web page.

## Root Causes Identified

### 1. BLE Pairing Check Blocking Sends
The `tuya_ble_send_packet()` function in `ble_mgr.c` was checking `ble->is_paired` and returning early if not paired:
```c
if (!ble->is_paired) {
    PR_NOTICE("ble not paired");
    return OPRT_OK;  // Silently fails to send!
}
```

### 2. WiFi Scan Disrupting Connection
Calling `tal_wifi_all_ap_scan()` while WiFi is connected causes the WiFi stack to disconnect and reconnect, which also disrupts the BLE connection.

### 3. Auto-Reconnect After Disconnect
The Tuya network manager (`netconn_wifi.c`) automatically reconnects to the saved WiFi network after a disconnect.

## Solutions Implemented

### Fix 1: Bypass Pairing Check for Dev Mode
Modified `src/tuya_cloud_service/ble/ble_mgr.c` to allow sending without pairing:

```c
int tuya_ble_send_packet(ble_packet_t *packet)
{
    tuya_ble_mgr_t *ble = s_ble_mgr;

    if (!ble->is_paired) {
        /* Dev mode: allow sending without pairing, use no encryption */
        PR_DEBUG("ble sending unencrypted (dev mode)");
        packet->encrypt_mode = ENCRYPTION_MODE_NONE;
    } else if (FRM_QRY_DEV_INFO_REQ == packet->type) {
        // ... normal encrypted flow
    }
    // ... rest of function continues instead of returning early
}
```

### Fix 2: Add WiFi Connection State Check
Modified `ble_config.c` to check WiFi status before scanning:

```c
else if (strcmp(cmd->valuestring, "wifi_scan") == 0) {
    /* Check if WiFi is connected - scanning will disrupt connection */
    WF_STATION_STAT_E wifi_stat = WSS_IDLE;
    tal_wifi_station_get_status(&wifi_stat);
    
    if (wifi_stat == WSS_GOT_IP) {
        PR_WARN("WiFi is connected - scan will disrupt connection!");
        /* Send error response via BLE */
        const char *err_json = "{\"type\":\"error\",\"msg\":\"WiFi connected. Disconnect first to scan.\"}";
        // ... send response
        return;
    }
    // ... proceed with scan
}
```

### Fix 3: Add WiFi Disconnect Command
Added `wifi_disconnect` command that uses `netmgr_conn_set` to properly close the connection:

```c
else if (strcmp(cmd->valuestring, "wifi_disconnect") == 0) {
    PR_NOTICE("BLE config: WiFi disconnect requested");
    
    /* Use netmgr to properly close connection and stop auto-reconnect */
    extern OPERATE_RET netmgr_conn_set(int type, int cmd, void *param);
    netmgr_conn_set(1, 6, NULL);  /* NETCONN_WIFI=1, NETCONN_CMD_CLOSE=6 */
    
    // ... send acknowledgment via BLE
}
```

### Fix 4: Send WiFi List Back via BLE
Updated `wifi_scan` handler to send results back to the web page:

```c
/* Build JSON response with WiFi list */
cJSON *resp_json = cJSON_CreateObject();
cJSON_AddStringToObject(resp_json, "type", "wifi_list");
cJSON *networks = cJSON_CreateArray();

for (uint32_t i = 0; i < max_networks; i++) {
    if (strlen((char*)ap_info[i].ssid) > 0) {
        cJSON *net = cJSON_CreateObject();
        cJSON_AddStringToObject(net, "ssid", (char*)ap_info[i].ssid);
        cJSON_AddNumberToObject(net, "rssi", ap_info[i].rssi);
        cJSON_AddNumberToObject(net, "ch", ap_info[i].channel);
        cJSON_AddItemToArray(networks, net);
    }
}

/* Send via BLE transparent channel */
uint8_t *resp = tal_malloc(4 + json_len);
resp[0] = 0x00; resp[1] = 0x00; resp[2] = 0x00; resp[3] = BLE_CHANNEL_CONFIG;
memcpy(resp + 4, json_str, json_len);
tuya_ble_send(FRM_UPLINK_TRANSPARENT_REQ, 0, resp, 4 + json_len);
```

### Fix 5: Update Web Page UI
Added to `ble-config-web/index.html`:

1. **Disconnect WiFi button** (red) alongside Scan WiFi button
2. **BLE Log panel** in Status tab to show incoming data
3. **Better response parsing** for the 4-byte header format

```html
<div style="display: flex; gap: 8px; margin-bottom: 16px;">
    <button class="btn btn-secondary" onclick="scanWifi()" id="scanWifiBtn" style="flex: 1;">
        <span>üîç</span> Scan WiFi
    </button>
    <button class="btn btn-secondary" onclick="disconnectWifi()" id="disconnectWifiBtn" style="flex: 1; background: #dc3545;">
        <span>üì¥</span> Disconnect WiFi
    </button>
</div>
```

BLE Log panel:
```html
<h3 style="margin-bottom: 8px;">üì° BLE Log</h3>
<div id="bleLog" style="background: #1a1a2e; border-radius: 8px; padding: 12px; max-height: 200px; overflow-y: auto; font-family: monospace; font-size: 12px; color: #0f0;">
    <div>Waiting for BLE data...</div>
</div>
```

## Files Modified

### DevKit Firmware
- `src/tuya_cloud_service/ble/ble_mgr.c` - Bypass pairing check for dev mode
- `apps/tuya_cloud/object_detection/src/ble_config.c` - Add WiFi state check, disconnect command, send WiFi list via BLE

### Web Bluetooth Page
- `ble-config-web/index.html` - Add disconnect button, BLE log panel, response parsing fixes

## Protocol Format

### BLE Transparent Data Response (DevKit ‚Üí Web)
```
[0]: flags_low (0x00)
[1]: flags_high (0x00)
[2]: channel_type_high (0x00)
[3]: channel_type_low (0x00 for config channel)
[4+]: JSON data string
```

### JSON Response Types
```json
// WiFi list
{"type":"wifi_list","networks":[{"ssid":"NetworkName","rssi":-62,"ch":4},...]}

// Acknowledgment
{"type":"ack","msg":"WiFi disconnected"}

// Error
{"type":"error","msg":"WiFi connected. Disconnect first to scan."}
```

## User Flow

1. **Connect to DevKit** via Web Bluetooth
2. **Disconnect WiFi** first (click red button)
3. **Scan WiFi** - networks appear in the list
4. **Select network** and enter password
5. **Connect to WiFi** - DevKit connects to new network

## Key Learnings

1. **Tuya BLE requires pairing** for encrypted communication - we bypassed this for dev mode
2. **WiFi scanning disrupts existing connections** - must disconnect first
3. **Network manager auto-reconnects** - use `NETCONN_CMD_CLOSE` to properly stop it
4. **BLE responses need proper framing** - 4-byte header + JSON payload
