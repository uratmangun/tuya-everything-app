# Audio Fix Session - Part 4

## Problem
Audio was not playing when toggling the switch in Tuya Smart Life app. The audio player was starting and immediately ending without producing sound.

## Root Causes Found

### 1. Audio Device Not Opened
`ai_audio_player_init()` only calls `tdl_audio_find()` but doesn't call `tdl_audio_open()`. Without opening the device, volume control fails with `OPRT_RESOURCE_NOT_READY` (-23).

### 2. Playback Ending Too Quickly
The player checked if all data was decoded and immediately transitioned to FINISH state, without waiting for the audio output buffer to drain.

## Fixes Applied

### File 1: `/apps/tuya_cloud/object_detection/src/tuya_main.c`

Added include:
```c
#include "tdl_audio_manage.h"
```

Modified audio initialization to open the device:
```c
/* Initialize the audio player */
PR_INFO("Initializing audio player...");
rt = ai_audio_player_init();
if (rt != OPRT_OK) {
    PR_ERR("Failed to initialize audio player: %d", rt);
    g_audio_initialized = false;
} else {
    PR_INFO("Audio player initialized successfully");
    
    /* Open the audio device to enable playback */
    TDL_AUDIO_HANDLE_T audio_hdl = NULL;
    rt = tdl_audio_find(AUDIO_CODEC_NAME, &audio_hdl);
    if (rt != OPRT_OK) {
        PR_ERR("Failed to find audio codec: %d", rt);
        g_audio_initialized = false;
    } else {
        rt = tdl_audio_open(audio_hdl, NULL);
        if (rt != OPRT_OK) {
            PR_ERR("Failed to open audio device: %d", rt);
            g_audio_initialized = false;
        } else {
            PR_INFO("Audio device opened successfully");
            g_audio_initialized = true;
            
            /* Set default volume */
            PR_INFO("Setting default volume to %d", DEFAULT_VOLUME);
            rt = ai_audio_set_volume(DEFAULT_VOLUME);
            if (rt != OPRT_OK) {
                PR_ERR("Failed to set volume: %d", rt);
            } else {
                PR_INFO("Volume set successfully");
            }
        }
    }
}
```

Improved `play_detection_alert()`:
```c
static void play_detection_alert(void)
{
    if (!g_audio_initialized) {
        PR_WARN("Audio not initialized, cannot play alert");
        return;
    }
    
    /* Stop any currently playing audio first */
    if (ai_audio_player_is_playing()) {
        PR_DEBUG("Stopping previous audio before playing new alert");
        ai_audio_player_stop();
    }
    
    PR_INFO("Playing detection alert audio (size=%d bytes)...", sizeof(alert_audio_data));
    
    OPERATE_RET rt = ai_audio_player_start("detection_alert");
    if (rt != OPRT_OK) {
        PR_ERR("Failed to start audio player: %d", rt);
        return;
    }
    
    PR_DEBUG("Audio player started, writing data...");
    
    rt = ai_audio_player_data_write("detection_alert", 
                                     (uint8_t *)alert_audio_data, 
                                     sizeof(alert_audio_data), 
                                     1);
    if (rt != OPRT_OK) {
        PR_ERR("Failed to write audio data: %d", rt);
    } else {
        PR_INFO("Audio data written successfully, playback should start");
    }
}
```

### File 2: `/apps/tuya.ai/ai_components/ai_audio/src/ai_audio_player.c`

Added member to `APP_PLAYER_T` structure:
```c
uint8_t finish_delay_count; // delay counter for audio output buffer drain
```

Reset counter on IDLE state:
```c
case AI_AUDIO_PLAYER_STAT_IDLE: {
    if (tal_sw_timer_is_running(ctx->tm_id)) {
        tal_sw_timer_stop(ctx->tm_id);
    }
    ctx->is_eof = 0;
    ctx->finish_delay_count = 0;
} break;
```

Reset counter on START state:
```c
case AI_AUDIO_PLAYER_STAT_START: {
    rt = __ai_audio_player_mp3_start();
    if (rt != OPRT_OK) {
        ctx->stat = AI_AUDIO_PLAYER_STAT_IDLE;
    } else {
        ctx->stat = AI_AUDIO_PLAYER_STAT_PLAY;
    }
    ctx->is_first_play = 1;
    ctx->finish_delay_count = 0;
    start_time = tal_system_get_millisecond();
} break;
```

Added delay before finishing in PLAY state:
```c
if (rb_used_len == 0 && 0 == ctx->mp3_raw_used_len && ctx->is_eof) {
    /* Wait for audio output buffer to drain before finishing */
    if (ctx->finish_delay_count < 100) { /* ~500ms delay (100 * 5ms) */
        ctx->finish_delay_count++;
        break;
    }
    ctx->finish_delay_count = 0;
    PR_DEBUG("app player end");
    ctx->stat = AI_AUDIO_PLAYER_STAT_FINISH;
}
```

### File 3: `/apps/tuya_cloud/object_detection/src/cli_cmd.c`

Added audio test CLI command for debugging:
```c
#include "ai_audio_player.h"
#include "ai_audio.h"
#include "alert_audio_data.h"

static void audio_test(int argc, char *argv[])
{
    OPERATE_RET rt = OPRT_OK;
    
    if (argc < 2) {
        PR_INFO("usage: audio <play|stop|vol <0-100>>");
        return;
    }
    
    if (0 == strcmp(argv[1], "play")) {
        if (ai_audio_player_is_playing()) {
            ai_audio_player_stop();
        }
        rt = ai_audio_player_start("cli_test");
        if (rt != OPRT_OK) {
            PR_ERR("Failed to start audio player: %d", rt);
            return;
        }
        rt = ai_audio_player_data_write("cli_test", 
                                         (uint8_t *)alert_audio_data, 
                                         sizeof(alert_audio_data), 
                                         1);
        if (rt != OPRT_OK) {
            PR_ERR("Failed to write audio data: %d", rt);
        }
    } else if (0 == strcmp(argv[1], "stop")) {
        ai_audio_player_stop();
    } else if (0 == strcmp(argv[1], "vol")) {
        if (argc < 3) {
            PR_INFO("Current volume: %d", ai_audio_get_volume());
            return;
        }
        uint8_t vol = (uint8_t)atoi(argv[2]);
        if (vol > 100) vol = 100;
        rt = ai_audio_set_volume(vol);
        if (rt != OPRT_OK) {
            PR_ERR("Failed to set volume: %d", rt);
        }
    }
}

// Register in s_cli_cmd array:
{.name = "audio", .func = audio_test, .help = "audio test <play|stop|vol>"},
```

## Debugging Notes

- **Log port**: `/dev/ttyACM2` at 460800 baud
- **Command port**: `/dev/ttyACM0` at 115200 baud
- Monitor command: `python3 tos.py monitor` (select port 2 for logs)

## Verification

Boot logs show successful initialization:
```
[ty I] Initializing audio player...
[ty D] app player init...
[ty D] app player mp3 init...
[ty D] app player init success
[ty I] Audio player initialized successfully
--- audio trace, init, sample: 16000, frame size: 640
audio init complete, sample: 16000
[ty I] Audio device opened successfully
[ty I] Setting default volume to 70
[ty I] Volume set successfully
```

Playback logs show audio being sent to speaker:
```
[ty I] Starting audio playback...
[ty N] ai audio player start
[ty I] Audio data written (7605 bytes), playing...
[ONBOARD_SPK] data_size: 40320(Bytes), 9KB/s
[ty D] app player end
```
