# Volume Control Implementation for DevKit Mic and Speaker

## Summary

Added volume control sliders (0-100) for both the DevKit speaker and microphone gain in the web UI. Users can adjust volume levels and send commands to the DevKit via WebSocket â†’ Go Server â†’ TCP â†’ DevKit.

## Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     WebSocket      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      TCP Protocol    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Web Browser   â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚   Go Server     â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚   T5AI DevKit   â”‚
â”‚                 â”‚   setvol:speaker:X â”‚   (VPS)         â”‚   setvol:speaker:X  â”‚                 â”‚
â”‚  Volume Slider  â”‚   setvol:mic:X     â”‚   Passthrough   â”‚   setvol:mic:X      â”‚  ai_audio API   â”‚
â”‚                 â”‚                    â”‚                 â”‚                     â”‚  tkl_ai_set_vol â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â–²                                                                              â”‚
         â”‚                              ok:vol:speaker:X                                â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ok:vol:mic:Xâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Files Changed

### 1. Web Application (webapp/public/index.html)

Added volume control UI with sliders for speaker and mic:

```html
<!-- Volume Controls -->
<div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border-color);">
    <div style="margin-bottom: 0.75rem; font-size: 0.85rem;">
        <span style="color: var(--accent-orange);">ğŸšï¸ Volume Controls</span>
    </div>
    <!-- Speaker Volume -->
    <div style="margin-bottom: 0.75rem;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <label style="font-size: 0.8rem; color: var(--text-secondary);">ğŸ”Š Speaker</label>
            <span id="speaker-vol-value">70</span>
        </div>
        <div style="display: flex; gap: 0.5rem; align-items: center;">
            <input type="range" id="speaker-volume" min="0" max="100" value="70">
            <button onclick="setVolume('speaker', document.getElementById('speaker-volume').value)">Set</button>
        </div>
    </div>
    <!-- Mic Volume -->
    <div style="margin-bottom: 0.5rem;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <label style="font-size: 0.8rem; color: var(--text-secondary);">ğŸ¤ Mic Gain</label>
            <span id="mic-vol-value">50</span>
        </div>
        <div style="display: flex; gap: 0.5rem; align-items: center;">
            <input type="range" id="mic-volume" min="0" max="100" value="50">
            <button onclick="setVolume('mic', document.getElementById('mic-volume').value)">Set</button>
        </div>
    </div>
    <div id="volume-status" style="display: none;"></div>
</div>
```

Added JavaScript functions for volume control:

```javascript
// Volume Control
function setVolume(type, value) {
    const vol = parseInt(value);
    if (isNaN(vol) || vol < 0 || vol > 100) {
        log('error', 'Invalid volume value');
        return;
    }

    if (!ws || ws.readyState !== WebSocket.OPEN) {
        log('error', 'WebSocket not connected');
        return;
    }

    const cmd = `setvol:${type}:${vol}`;
    log('info', `Setting ${type} volume to ${vol}...`);
    
    ws.send(JSON.stringify({
        type: 'send_to_devkit',
        data: cmd
    }));

    // Show status
    const statusEl = document.getElementById('volume-status');
    statusEl.textContent = `Setting ${type} volume to ${vol}...`;
    statusEl.style.display = 'block';
}

// Handle volume status responses in handleMessage()
if (data.data && data.data.startsWith('ok:vol:')) {
    const parts = data.data.split(':');
    if (parts.length >= 4) {
        const type = parts[2];
        const vol = parseInt(parts[3]);
        // Update UI slider and display
        if (type === 'speaker') {
            document.getElementById('speaker-volume').value = vol;
            document.getElementById('speaker-vol-value').textContent = vol;
        } else if (type === 'mic') {
            document.getElementById('mic-volume').value = vol;
            document.getElementById('mic-vol-value').textContent = vol;
        }
    }
}
```

### 2. DevKit Firmware (apps/tuya_cloud/object_detection/src/tuya_main.c)

Added include for tkl_audio.h:

```c
/* Audio player includes */
#include "ai_audio_player.h"
#include "ai_audio.h"
#include "alert_audio_data.h"
#include "tdl_audio_manage.h"
#include "tkl_audio.h"  // Added for tkl_ai_set_vol()
```

Added forward declaration:

```c
/* Forward declarations */
static void update_speaker_gpio(uint8_t volume);
```

Added TCP command handlers for volume control:

```c
else if (strncmp(data, "setvol:speaker:", 15) == 0) {
    /* Set speaker volume: "setvol:speaker:<0-100>" */
    int volume = atoi(data + 15);
    if (volume < 0) volume = 0;
    if (volume > 100) volume = 100;
    
    PR_INFO("[VOLUME] Setting speaker volume to %d", volume);
    g_current_volume = (uint8_t)volume;
    
    /* Set DAC gain via ai_audio API */
    OPERATE_RET rt = ai_audio_set_volume((uint8_t)volume);
    if (rt != OPRT_OK) {
        PR_ERR("[VOLUME] Failed to set speaker volume: %d", rt);
        snprintf(response, sizeof(response), "error:vol:speaker:%d", rt);
    } else {
        /* Control speaker amplifier GPIO based on volume */
        update_speaker_gpio((uint8_t)volume);
        snprintf(response, sizeof(response), "ok:vol:speaker:%d", volume);
    }
    tcp_client_send_str(response);
}
else if (strncmp(data, "setvol:mic:", 11) == 0) {
    /* Set microphone gain: "setvol:mic:<0-100>" */
    int volume = atoi(data + 11);
    if (volume < 0) volume = 0;
    if (volume > 100) volume = 100;
    
    PR_INFO("[VOLUME] Setting mic gain to %d", volume);
    
    /* Set mic gain via TKL API */
    OPERATE_RET rt = tkl_ai_set_vol(TKL_AUDIO_TYPE_BOARD, 0, volume);
    if (rt != OPRT_OK) {
        PR_ERR("[VOLUME] Failed to set mic gain: %d", rt);
        snprintf(response, sizeof(response), "error:vol:mic:%d", rt);
    } else {
        snprintf(response, sizeof(response), "ok:vol:mic:%d", volume);
    }
    tcp_client_send_str(response);
}
```

Updated status command to include speaker_vol:

```c
else if (strncmp(data, "status", 6) == 0) {
    int heap = tal_system_get_free_heap_size();
    snprintf(response, sizeof(response), 
        "{\"detection\":%s,\"speaker_vol\":%d,\"audio_init\":%s,\"mic_streaming\":%s,\"heap\":%d}",
        g_detection_active ? "true" : "false",
        g_current_volume,
        g_audio_initialized ? "true" : "false",
        mic_streaming_is_active() ? "true" : "false",
        heap);
    tcp_client_send_str(response);
}
```

## Protocol

### Commands (Browser â†’ DevKit)

| Command | Description |
|---------|-------------|
| `setvol:speaker:<0-100>` | Set speaker output volume |
| `setvol:mic:<0-100>` | Set microphone input gain |

### Responses (DevKit â†’ Browser)

| Response | Description |
|----------|-------------|
| `ok:vol:speaker:<value>` | Speaker volume set successfully |
| `ok:vol:mic:<value>` | Mic gain set successfully |
| `error:vol:speaker:<code>` | Failed to set speaker volume |
| `error:vol:mic:<code>` | Failed to set mic gain |

## APIs Used

### Speaker Volume
- `ai_audio_set_volume(uint8_t volume)` - Sets DAC output volume (0-100)
- `update_speaker_gpio(uint8_t volume)` - Controls speaker amplifier GPIO (mute when 0)

### Microphone Gain
- `tkl_ai_set_vol(int32_t card, TKL_AI_CHN_E chn, int32_t vol)` - Sets ADC input gain (0-100)

## Deployment Commands

### Build and Flash DevKit:
```fish
cd /home/uratmangun/CascadeProjects/TuyaOpen/apps/tuya_cloud/object_detection
fish -c "source build_with_env.fish; and ../../../tos.py build"
../../../tos.py flash -p /dev/ttyACM0
```

### Deploy Web App to VPS:
```fish
cd /home/uratmangun/CascadeProjects/TuyaOpen/webapp
rsync -avz --exclude='.git' . ubuntu@YOUR_TAILSCALE_IP:~/tuya-webapp/

ssh ubuntu@YOUR_TAILSCALE_IP "
  podman stop tuya-webapp-go 2>/dev/null
  podman rm tuya-webapp-go 2>/dev/null
  cd ~/tuya-webapp
  podman build -t tuya-webapp-go:latest .
  podman run -d --name tuya-webapp-go --network host \
    -e AUTH_USERNAME=admin \
    -e AUTH_PASSWORD=YOUR_AUTH_PASSWORD \
    -e AUTH_TOKEN=YOUR_AUTH_TOKEN \
    -e HTTP_PORT=3000 \
    -e TCP_PORT=5000 \
    -e UDP_PORT=5001 \
    tuya-webapp-go:latest
"
```

## Testing

1. Open web UI at `https://your-domain.com`
2. Connect DevKit (should show "Connected" status)
3. In the "Quick Commands" section, find the "ğŸšï¸ Volume Controls" panel
4. Adjust the Speaker slider (0-100) and click "Set"
5. Adjust the Mic Gain slider (0-100) and click "Set"
6. Verify the status message shows "âœ“ speaker/mic volume set to X"

## Related Files

| File | Purpose |
|------|---------|
| `webapp/public/index.html` | Web UI with volume sliders |
| `apps/tuya_cloud/object_detection/src/tuya_main.c` | DevKit TCP command handlers |
| `tools/porting/adapter/media/tkl_audio.h` | TKL audio API definitions |
| `apps/tuya.ai/ai_components/ai_audio/include/ai_audio.h` | AI audio API (speaker volume) |
