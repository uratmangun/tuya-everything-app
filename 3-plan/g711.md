# G.711 Audio Streaming Implementation

## Overview

This document details the G.711 u-law audio encoding implementation for the T5AI DevKit microphone streaming feature. The implementation fixes garbled audio issues caused by raw PCM over UDP.

## Problem

The original implementation sent raw 16-bit PCM audio over UDP, which caused:
- **Byte Alignment Issues**: If any byte is dropped, the 16-bit sample boundaries shift, causing loud static
- **Endianness Mismatches**: ARM (Little Endian) vs Go server interpretation
- **No Packet Loss Detection**: Dropped packets corrupt the entire stream

## Solution: G.711 u-law Encoding

G.711 compresses 16-bit PCM to 8-bit u-law, providing:
- **50% bandwidth reduction** (8-bit vs 16-bit)
- **1 byte = 1 sample** (no byte alignment issues if packet dropped)
- **Sequence numbers** for packet loss/jitter detection
- **Robust streaming** - dropped packets only affect that instant of audio

### Packet Format

```
[SEQ:1 byte][G711_DATA:N bytes]
```

- `SEQ`: 0-255 sequence number (wraps around)
- `G711_DATA`: G.711 u-law encoded audio samples

---

## Implementation Details

### Firmware (`apps/tuya_cloud/object_detection/src/`)

#### NEW FILES (created from scratch):

| File | Lines | Description |
|------|-------|-------------|
| `g711_codec.h` | 1-61 | G.711 u-law codec header |
| `g711_codec.c` | 1-99 | G.711 u-law encoder/decoder implementation |

#### MODIFIED FILES:

| File | Lines Changed | Description |
|------|--------------|-------------|
| `udp_audio.h` | **1-60** (entire file rewritten) | Added `udp_audio_send_pcm()`, sequence number support |
| `udp_audio.c` | **1-175** (entire file rewritten) | G.711 encoding, sequence numbers, packet framing |
| `mic_streaming.c` | **1-313** (entire file rewritten) | Uses `udp_audio_send_pcm()` with PCM samples instead of raw bytes |

**Key changes in `mic_streaming.c`:**
- Line 128: Task now logs "G.711 over UDP"
- Lines 159-168: Calls `udp_audio_send_pcm()` instead of `udp_audio_send()`
- Line 286: Startup log shows "G.711 over UDP"

---

### Webapp (`webapp/`)

#### MODIFIED FILES:

| File | Lines Changed | Description |
|------|--------------|-------------|
| `main.go` | **77-145** | Added G.711 u-law decoding table + `decodeG711ULaw()` function |
| `main.go` | **366-412** | UDP server now extracts sequence number and decodes G.711 |
| `main.go` | **701** | Audio stream header updated to `16000hz` |

**Key `main.go` additions:**
- Lines 77-142: `ulawToLinear` lookup table (256 entries)
- Lines 144-153: `decodeG711ULaw()` function
- Lines 380-407: Sequence number extraction + G.711 decode in UDP handler

#### `public/index.html`:

| Lines Changed | Description |
|--------------|-------------|
| **746-749** | Added `AUDIO_SAMPLE_RATE = 16000` and `AUDIO_CHUNK_SIZE = 640` constants |
| **753** | Audio buffer uses `AUDIO_SAMPLE_RATE` (16000) instead of 8000 |
| **770** | Buffer timing reduced to 80ms |
| **793-794** | AudioContext created without fixed sample rate |
| **820** | Initial buffer reduced to 100ms |
| **827** | Status text shows "G.711 Streaming (16kHz)" |
| **876-879** | Chunk processing uses `AUDIO_CHUNK_SIZE` (640 bytes) |

---

## Data Flow

```
┌─────────────────────┐
│ T5AI Microphone     │
│ 16kHz 16-bit PCM    │
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│ g711_codec.c        │
│ PCM → G.711 u-law   │
│ (16-bit → 8-bit)    │
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│ udp_audio.c         │
│ Add sequence number │
│ [SEQ][G711_DATA]    │
└──────────┬──────────┘
           │
           ▼ UDP Port 5001
┌─────────────────────┐
│ main.go (Server)    │
│ Extract SEQ         │
│ Decode G.711 → PCM  │
└──────────┬──────────┘
           │
           ▼ HTTP /audio-stream
┌─────────────────────┐
│ Browser             │
│ Web Audio API       │
│ Play at 16kHz       │
└─────────────────────┘
```

---

## Core G.711 Algorithm

### Encoding (Firmware - `g711_codec.c`)

```c
uint8_t g711_linear_to_ulaw(int16_t pcm)
{
    int16_t seg;
    uint8_t uval;
    int16_t mask;
    int16_t pcm_val = pcm;

    /* Get the sign bit */
    if (pcm_val < 0) {
        pcm_val = -pcm_val;
        mask = 0x7F;
    } else {
        mask = 0xFF;
    }

    /* Clip the magnitude */
    if (pcm_val > ULAW_CLIP)
        pcm_val = ULAW_CLIP;

    /* Add bias for u-law */
    pcm_val += ULAW_BIAS;

    /* Find the segment and combine */
    seg = search(pcm_val, seg_end, 8);
    uval = (seg << 4) | ((pcm_val >> (seg + 3)) & 0x0F);
    uval ^= mask;

    return uval;
}
```

### Decoding (Server - `main.go`)

```go
// G.711 u-law decoding table (256 entries)
var ulawToLinear = [256]int16{
    -32124, -31100, -30076, ... // Full table omitted
}

func decodeG711ULaw(ulaw []byte) []byte {
    pcm := make([]byte, len(ulaw)*2)
    for i, u := range ulaw {
        sample := ulawToLinear[u]
        // Little-endian 16-bit
        pcm[i*2] = byte(sample & 0xFF)
        pcm[i*2+1] = byte((sample >> 8) & 0xFF)
    }
    return pcm
}
```

---

## Audio Parameters

| Parameter | Value |
|-----------|-------|
| Sample Rate | 16,000 Hz |
| Bit Depth (Source) | 16-bit PCM |
| Bit Depth (Encoded) | 8-bit G.711 u-law |
| Channels | Mono |
| Frame Size | 320 samples (20ms) |
| Frame Bytes (PCM) | 640 bytes |
| Frame Bytes (G.711) | 320 bytes + 1 byte seq = 321 bytes |
| Bandwidth Reduction | 50% |

---

## Testing

1. Connect DevKit to TCP server
2. Send `mic on` command via web UI
3. Click "Start" on microphone stream
4. Verify log shows: `G.711 Streaming (16kHz)`
5. Speak into microphone - audio should be clear without garbling

### Server Logs (Success)

```
[UDP] G.711 packet #1 from <ip>: seq=0, g711_bytes=320
[UDP] G.711 packet #100 from <ip>: seq=99, g711_bytes=320
```

### DevKit Logs (Success)

```
[mic_streaming.c] Mic streaming started (G.711 over UDP to x.x.x.x:5001)
[udp_audio.c] UDP audio: 500 packets sent, seq=244, last_size=321
```

---

## Date Implemented

**2025-12-20**

## Status

✅ **WORKING** - Garbled audio issue resolved
